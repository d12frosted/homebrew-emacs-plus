name: Build Emacs.app

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Emacs version to build'
        required: true
        default: '30'
        type: choice
        options:
          - '30'
          - '31'

  # TODO Phase 2: Enable nightly builds
  # schedule:
  #   - cron: '0 3 * * *'  # 3 AM UTC daily

jobs:
  build:
    runs-on: macos-26  # Phase 1: test on Tahoe (add matrix later)
    steps:
      - uses: actions/checkout@v4

      - name: Set environment
        run: |
          echo "EMACS_VERSION=${{ inputs.version || '30' }}" >> $GITHUB_ENV
          echo "MAC_ARCH=$(uname -m)" >> $GITHUB_ENV
          echo "OS_VER=$(sw_vers -productVersion)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          brew update
          # Use tree-sitter@0.25 for Emacs 30 compatibility (0.26+ has API changes)
          brew install autoconf automake texinfo gnutls librsvg libxml2 \
            imagemagick libgccjit tree-sitter@0.25 pkg-config
          # Ensure tree-sitter@0.25 is in PATH
          echo "$(brew --prefix tree-sitter@0.25)/bin" >> $GITHUB_PATH
          export PKG_CONFIG_PATH="$(brew --prefix tree-sitter@0.25)/lib/pkgconfig:$PKG_CONFIG_PATH"
          echo "PKG_CONFIG_PATH=$(brew --prefix tree-sitter@0.25)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      - name: Clone Emacs source
        run: |
          if [[ "$EMACS_VERSION" == "31" ]]; then
            BRANCH="master"
          else
            BRANCH="emacs-$EMACS_VERSION"
          fi
          git clone --depth 1 --branch "$BRANCH" \
            https://git.savannah.gnu.org/git/emacs.git emacs-src
          cd emacs-src
          echo "EMACS_REV=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "Building Emacs $EMACS_VERSION at $(git rev-parse --short HEAD)"

      - name: Apply unconditional patches
        run: |
          cd emacs-src
          # Only apply patches that are unconditionally applied in the formula
          PATCHES=(
            "fix-window-role"
            "system-appearance"
            "round-undecorated-frame"
            "mac-font-use-typo-metrics"
          )
          for patch_name in "${PATCHES[@]}"; do
            patch_file="../patches/emacs-$EMACS_VERSION/${patch_name}.patch"
            if [[ -f "$patch_file" ]]; then
              echo "Applying $patch_name"
              patch -p1 < "$patch_file"
            else
              echo "Warning: $patch_file not found, skipping"
            fi
          done

      - name: Build Emacs
        run: |
          cd emacs-src
          ./autogen.sh
          ./configure \
            --with-ns \
            --with-native-compilation=aot \
            --with-xwidgets \
            --with-tree-sitter \
            --with-imagemagick \
            --with-mailutils \
            --with-modules \
            --without-dbus \
            --without-compress-install
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Verify build
        run: |
          ls -la emacs-src/nextstep/
          ./emacs-src/nextstep/Emacs.app/Contents/MacOS/Emacs --version

      - name: Bundle dylibs
        run: |
          APP="emacs-src/nextstep/Emacs.app"
          MACOS_DIR="$APP/Contents/MacOS"
          FRAMEWORKS_DIR="$APP/Contents/Frameworks"
          mkdir -p "$FRAMEWORKS_DIR"

          # Function to get non-system dylib dependencies
          get_dylibs() {
            otool -L "$1" 2>/dev/null | grep -E '^\t/(opt/homebrew|usr/local)' | awk '{print $1}'
          }

          # Function to get @rpath and @loader_path dependencies
          get_rpath_dylibs() {
            otool -L "$1" 2>/dev/null | grep -E '^\t@(rpath|loader_path)/' | awk '{print $1}'
          }

          # Function to resolve @rpath to actual file
          resolve_rpath() {
            local dylib_name=$(basename "$1")
            # Search in Homebrew locations
            for prefix in /opt/homebrew/lib /usr/local/lib; do
              if [[ -f "$prefix/$dylib_name" ]]; then
                echo "$prefix/$dylib_name"
                return 0
              fi
            done
            # Search in Cellar
            local found=$(find /opt/homebrew/Cellar -name "$dylib_name" -type f 2>/dev/null | head -1)
            if [[ -n "$found" ]]; then
              echo "$found"
              return 0
            fi
            echo ""
            return 1
          }

          # Function to copy and fix a dylib
          copy_and_fix_dylib() {
            local src="$1"
            local dest="$FRAMEWORKS_DIR/$(basename "$src")"

            if [[ -f "$dest" ]]; then
              return 0  # Already copied
            fi

            echo "Bundling: $src"
            cp -L "$src" "$dest"
            chmod 644 "$dest"

            # Fix the dylib's own ID
            install_name_tool -id "@executable_path/../Frameworks/$(basename "$src")" "$dest"

            # Recursively process this dylib's absolute path dependencies
            for dep in $(get_dylibs "$dest"); do
              local dep_name=$(basename "$dep")
              install_name_tool -change "$dep" "@executable_path/../Frameworks/$dep_name" "$dest"
              copy_and_fix_dylib "$dep"
            done

            # Also process @rpath dependencies
            for rpath_dep in $(get_rpath_dylibs "$dest"); do
              local resolved=$(resolve_rpath "$rpath_dep")
              if [[ -n "$resolved" ]]; then
                local dep_name=$(basename "$resolved")
                install_name_tool -change "$rpath_dep" "@executable_path/../Frameworks/$dep_name" "$dest"
                copy_and_fix_dylib "$resolved"
              else
                echo "Warning: Could not resolve $rpath_dep"
              fi
            done
          }

          # Process the main Emacs binary
          EMACS_BIN="$MACOS_DIR/Emacs"
          echo "Processing Emacs binary..."
          for dylib in $(get_dylibs "$EMACS_BIN"); do
            dylib_name=$(basename "$dylib")
            install_name_tool -change "$dylib" "@executable_path/../Frameworks/$dylib_name" "$EMACS_BIN"
            copy_and_fix_dylib "$dylib"
          done

          # Also process any helper binaries in bin/
          if [[ -d "$MACOS_DIR/bin" ]]; then
            for bin in "$MACOS_DIR/bin"/*; do
              if [[ -x "$bin" ]] && file "$bin" | grep -q "Mach-O"; then
                echo "Processing: $bin"
                for dylib in $(get_dylibs "$bin"); do
                  dylib_name=$(basename "$dylib")
                  install_name_tool -change "$dylib" "@executable_path/../Frameworks/$dylib_name" "$bin"
                  copy_and_fix_dylib "$dylib"
                done
              fi
            done
          fi

          # List bundled libraries
          echo "Bundled libraries:"
          ls -la "$FRAMEWORKS_DIR/"

          # Verify the binary no longer references /opt/homebrew
          echo "Checking for remaining Homebrew references..."
          if otool -L "$EMACS_BIN" | grep -q '/opt/homebrew\|/usr/local'; then
            echo "WARNING: Still has Homebrew references:"
            otool -L "$EMACS_BIN" | grep '/opt/homebrew\|/usr/local'
          else
            echo "OK: No Homebrew references in main binary"
          fi

      - name: Package
        run: |
          cd emacs-src/nextstep
          # Create version file
          echo "Emacs+ $EMACS_VERSION" > Emacs.app/Contents/Resources/emacs-plus-version.txt
          echo "Build: $BUILD_DATE" >> Emacs.app/Contents/Resources/emacs-plus-version.txt
          echo "Revision: $EMACS_REV" >> Emacs.app/Contents/Resources/emacs-plus-version.txt

          # Package
          ZIPNAME="emacs-plus-${EMACS_VERSION}-${MAC_ARCH}-${OS_VER}.zip"
          zip -r -y "$ZIPNAME" Emacs.app
          shasum -a 256 "$ZIPNAME" > "$ZIPNAME.sha256"
          mv "$ZIPNAME" "$ZIPNAME.sha256" "$GITHUB_WORKSPACE/"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: emacs-plus-${{ env.EMACS_VERSION }}-${{ env.MAC_ARCH }}-${{ env.OS_VER }}
          path: |
            emacs-plus-*.zip
            emacs-plus-*.sha256

  # TODO Phase 2: Add release job
  # release:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #   steps:
  #     - uses: actions/download-artifact@v4
  #     - uses: softprops/action-gh-release@v2
